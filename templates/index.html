<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Reddit Brand Monitor - Commercial Edition</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        * { box-sizing: border-box; margin: 0; padding: 0; }
        body { 
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', system-ui, sans-serif;
            background: #f8fafc; color: #334155; line-height: 1.6;
        }
        .header { 
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white; padding: 2rem; text-align: center;
        }
        .header h1 { font-size: 2.5rem; margin-bottom: 0.5rem; }
        .header p { opacity: 0.9; font-size: 1.1rem; }
        .container { max-width: 1200px; margin: 0 auto; padding: 2rem; }
        .tabs { display: flex; gap: 0.5rem; margin-bottom: 2rem; }
        .tab { 
            padding: 0.75rem 1.5rem; background: white; border: none; 
            border-radius: 8px; cursor: pointer; font-weight: 500;
            transition: all 0.2s; box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .tab:hover { transform: translateY(-1px); box-shadow: 0 4px 8px rgba(0,0,0,0.15); }
        .tab.active { background: #667eea; color: white; }
        .stats-grid { 
            display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 1.5rem; margin-bottom: 2rem;
        }
        .stat-card { 
            background: white; padding: 1.5rem; border-radius: 12px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1); text-align: center;
        }
        .stat-number { font-size: 2rem; font-weight: bold; color: #667eea; }
        .stat-label { color: #64748b; margin-top: 0.5rem; }
        .content-section { 
            background: white; border-radius: 12px; padding: 1.5rem;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1); margin-bottom: 2rem;
        }
        .mentions-table { width: 100%; border-collapse: collapse; }
        .mentions-table th, .mentions-table td { 
            padding: 0.75rem; text-align: left; border-bottom: 1px solid #e2e8f0;
        }
        .mentions-table th { background: #f8fafc; font-weight: 600; }
        .badge { 
            padding: 0.25rem 0.75rem; border-radius: 20px; font-size: 0.8rem;
            font-weight: 500; text-transform: capitalize;
        }
        .badge.positive { background: #dcfce7; color: #166534; }
        .badge.neutral { background: #f1f5f9; color: #475569; }
        .badge.negative { background: #fecaca; color: #991b1b; }
        .btn { 
            padding: 0.5rem 1rem; border: none; border-radius: 6px;
            cursor: pointer; font-weight: 500; transition: all 0.2s;
        }
        .btn-primary { background: #667eea; color: white; }
        .btn-primary:hover { background: #5a67d8; }
        .btn-danger { background: #ef4444; color: white; }
        .btn-danger:hover { background: #dc2626; }
        .filters { display: flex; gap: 1rem; margin-bottom: 1.5rem; flex-wrap: wrap; }
        .filter-input { 
            padding: 0.5rem; border: 1px solid #d1d5db; border-radius: 6px;
            font-size: 0.9rem;
        }
        .loading { text-align: center; padding: 2rem; color: #64748b; }
        .charts-container { display: grid; grid-template-columns: 1fr 1fr; gap: 2rem; }
        .chart-wrapper { text-align: center; }
        @media (max-width: 768px) {
            .charts-container { grid-template-columns: 1fr; }
            .filters { flex-direction: column; }
            .tabs { flex-wrap: wrap; }
        }
    </style>
</head>
<body>
    <div class="header">
        <h1>Reddit Brand Monitor</h1>
        <p>Real-time brand mention tracking with advanced analytics</p>
    </div>

    <div class="container">
        <div class="tabs">
            <button class="tab active" onclick="showTab('dashboard')" id="tab-dashboard">Dashboard</button>
            <button class="tab" onclick="showTab('mentions')" id="tab-mentions">Live Mentions</button>
            <button class="tab" onclick="showTab('analytics')" id="tab-analytics">Analytics</button>
            <button class="tab" onclick="showTab('settings')" id="tab-settings">Settings</button>
        </div>

        <!-- Dashboard Tab -->
        <div id="dashboard-tab" class="tab-content">
            <div class="stats-grid" id="stats-container">
                <div class="loading">Loading stats...</div>
            </div>
            
            <div class="content-section">
                <h3>Recent Activity</h3>
                <div class="charts-container">
                    <div class="chart-wrapper">
                        <h4>Sentiment Distribution</h4>
                        <canvas id="sentiment-chart" width="300" height="300"></canvas>
                    </div>
                    <div class="chart-wrapper">
                        <h4>Weekly Mentions</h4>
                        <canvas id="weekly-chart" width="300" height="300"></canvas>
                    </div>
                </div>
            </div>
        </div>

        <!-- Mentions Tab -->
        <div id="mentions-tab" class="tab-content" style="display: none;">
            <div class="content-section">
                <div class="filters">
                    <select class="filter-input" id="brand-filter">
                        <option value="badinka">Badinka</option>
                        <option value="iheartraves">IHeartRaves</option>
                    </select>
                    <input type="text" class="filter-input" id="subreddit-filter" placeholder="Filter by subreddit">
                    <select class="filter-input" id="sentiment-filter">
                        <option value="">All Sentiments</option>
                        <option value="positive">Positive</option>
                        <option value="neutral">Neutral</option>
                        <option value="negative">Negative</option>
                    </select>
                    <button class="btn btn-primary" onclick="loadMentions()">Refresh</button>
                    <button class="btn btn-primary" onclick="exportData()">Export CSV</button>
                </div>

                <table class="mentions-table">
                    <thead>
                        <tr>
                            <th>Type</th>
                            <th>Subreddit</th>
                            <th>Author</th>
                            <th>Content</th>
                            <th>Created</th>
                            <th>Score</th>
                            <th>Sentiment</th>
                            <th>Source</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody id="mentions-tbody">
                        <tr><td colspan="9" class="loading">Loading mentions...</td></tr>
                    </tbody>
                </table>
            </div>
        </div>

        <!-- Analytics Tab -->
        <div id="analytics-tab" class="tab-content" style="display: none;">
            <div class="content-section">
                <h3>Trending Subreddits</h3>
                <div id="trending-container" class="loading">Loading trending data...</div>
            </div>
        </div>

        <!-- Settings Tab -->
        <div id="settings-tab" class="tab-content" style="display: none;">
            <div class="content-section">
                <h3>System Status</h3>
                <div id="status-container" class="loading">Loading system status...</div>
            </div>
        </div>
    </div>

    <script>
        let currentBrand = 'badinka';
        let mentionsData = [];
        let charts = {};

        // Tab management
        function showTab(tabName) {
            document.querySelectorAll('.tab-content').forEach(tab => tab.style.display = 'none');
            document.querySelectorAll('.tab').forEach(tab => tab.classList.remove('active'));
            
            document.getElementById(tabName + '-tab').style.display = 'block';
            document.getElementById('tab-' + tabName).classList.add('active');
            
            if (tabName === 'dashboard') loadDashboard();
            else if (tabName === 'mentions') loadMentions();
            else if (tabName === 'analytics') loadAnalytics();
            else if (tabName === 'settings') loadSystemStatus();
        }

        // Load dashboard data
        async function loadDashboard() {
            try {
                const [statsRes, weeklyRes] = await Promise.all([
                    fetch(`/stats?brand=${currentBrand}`),
                    fetch(`/weekly_mentions?brand=${currentBrand}`)
                ]);
                
                const stats = await statsRes.json();
                const weekly = await weeklyRes.json();
                
                renderStats(stats);
                renderCharts(stats, weekly);
            } catch (error) {
                console.error('Error loading dashboard:', error);
            }
        }

        function renderStats(stats) {
            const container = document.getElementById('stats-container');
            container.innerHTML = `
                <div class="stat-card">
                    <div class="stat-number">${stats.daily.posts + stats.daily.comments}</div>
                    <div class="stat-label">Today's Mentions</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number">${stats.total.posts + stats.total.comments}</div>
                    <div class="stat-label">Total Mentions</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number">${stats.score}/100</div>
                    <div class="stat-label">Sentiment Score</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number">${Object.keys(stats.sources || {}).length}</div>
                    <div class="stat-label">Data Sources</div>
                </div>
            `;
        }

        function renderCharts(stats, weekly) {
            // Sentiment pie chart
            const sentimentCtx = document.getElementById('sentiment-chart').getContext('2d');
            if (charts.sentiment) charts.sentiment.destroy();
            
            charts.sentiment = new Chart(sentimentCtx, {
                type: 'pie',
                data: {
                    labels: ['Positive', 'Neutral', 'Negative'],
                    datasets: [{
                        data: [stats.sentiment.positive, stats.sentiment.neutral, stats.sentiment.negative],
                        backgroundColor: ['#22c55e', '#64748b', '#ef4444']
                    }]
                },
                options: { responsive: true, maintainAspectRatio: false }
            });

            // Weekly line chart
            const weeklyCtx = document.getElementById('weekly-chart').getContext('2d');
            if (charts.weekly) charts.weekly.destroy();
            
            const dates = Object.keys(weekly).sort();
            const counts = dates.map(date => weekly[date].total || 0);
            
            charts.weekly = new Chart(weeklyCtx, {
                type: 'line',
                data: {
                    labels: dates,
                    datasets: [{
                        label: 'Mentions',
                        data: counts,
                        borderColor: '#667eea',
                        backgroundColor: 'rgba(102, 126, 234, 0.1)',
                        fill: true
                    }]
                },
                options: { 
                    responsive: true, 
                    maintainAspectRatio: false,
                    scales: {
                        y: { beginAtZero: true }
                    }
                }
            });
        }

        // Load mentions
        async function loadMentions() {
            const brand = document.getElementById('brand-filter').value;
            const subreddit = document.getElementById('subreddit-filter').value;
            const sentiment = document.getElementById('sentiment-filter').value;
            
            let url = `/data?brand=${brand}&per_page=50`;
            if (subreddit) url += `&subreddit=${subreddit}`;
            if (sentiment) url += `&sentiment=${sentiment}`;
            
            try {
                const response = await fetch(url);
                const data = await response.json();
                mentionsData = data.results || [];
                renderMentions(mentionsData);
            } catch (error) {
                console.error('Error loading mentions:', error);
            }
        }

        function renderMentions(mentions) {
            const tbody = document.getElementById('mentions-tbody');
            if (mentions.length === 0) {
                tbody.innerHTML = '<tr><td colspan="9" class="loading">No mentions found</td></tr>';
                return;
            }
            
            tbody.innerHTML = mentions.map(mention => `
                <tr>
                    <td>${mention.type}</td>
                    <td>r/${mention.subreddit}</td>
                    <td>u/${mention.author}</td>
                    <td>
                        <div style="max-width: 300px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap;">
                            ${mention.title || mention.body || ''}
                        </div>
                        <a href="${mention.permalink}" target="_blank" style="font-size: 0.8rem; color: #667eea;">View →</a>
                    </td>
                    <td>${new Date(mention.created).toLocaleDateString()}</td>
                    <td>${mention.score}</td>
                    <td><span class="badge ${mention.sentiment || 'neutral'}">${mention.sentiment || 'neutral'}</span></td>
                    <td>${mention.source}</td>
                    <td>
                        <button class="btn btn-danger" onclick="deleteMention('${mention.id}')" style="font-size: 0.8rem;">Delete</button>
                    </td>
                </tr>
            `).join('');
        }

        // Load analytics
        async function loadAnalytics() {
            try {
                const response = await fetch(`/trending_subreddits?brand=${currentBrand}`);
                const trending = await response.json();
                
                const container = document.getElementById('trending-container');
                container.innerHTML = `
                    <table class="mentions-table">
                        <thead>
                            <tr>
                                <th>Subreddit</th>
                                <th>Mentions</th>
                                <th>Avg Score</th>
                                <th>Positive %</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${trending.map(item => `
                                <tr>
                                    <td>r/${item.subreddit}</td>
                                    <td>${item.mention_count}</td>
                                    <td>${item.avg_score.toFixed(1)}</td>
                                    <td>${(item.sentiment_ratio * 100).toFixed(1)}%</td>
                                </tr>
                            `).join('')}
                        </tbody>
                    </table>
                `;
            } catch (error) {
                console.error('Error loading analytics:', error);
            }
        }

        // Load system status
        async function loadSystemStatus() {
            try {
                const response = await fetch('/system_status');
                const status = await response.json();
                
                const container = document.getElementById('status-container');
                container.innerHTML = `
                    <div class="stats-grid">
                        <div class="stat-card">
                            <div class="stat-number">${status.total_mentions}</div>
                            <div class="stat-label">Total Mentions</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-number">${status.total_brands}</div>
                            <div class="stat-label">Brands Tracked</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-number">${status.total_subreddits}</div>
                            <div class="stat-label">Subreddits</div>
                        </div>
                    </div>
                    
                    <h4>Data Sources</h4>
                    <table class="mentions-table">
                        <thead>
                            <tr><th>Source</th><th>Total Mentions</th><th>Last Update</th></tr>
                        </thead>
                        <tbody>
                            ${status.sources.map(source => `
                                <tr>
                                    <td>${source.source}</td>
                                    <td>${source.count}</td>
                                    <td>${source.last_update ? new Date(source.last_update).toLocaleString() : 'N/A'}</td>
                                </tr>
                            `).join('')}
                        </tbody>
                    </table>
                `;
            } catch (error) {
                console.error('Error loading system status:', error);
            }
        }

        // Utility functions
        async function deleteMention(id) {
            if (!confirm('Are you sure you want to delete this mention?')) return;
            
            try {
                await fetch('/delete', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ id })
                });
                loadMentions();
            } catch (error) {
                console.error('Error deleting mention:', error);
            }
        }

        function exportData() {
            const brand = document.getElementById('brand-filter').value;
            window.open(`/export?brand=${brand}&format=csv`, '_blank');
        }

        // Initialize
        document.addEventListener('DOMContentLoaded', () => {
            loadDashboard();
            setInterval(loadDashboard, 30000); // Refresh every 30 seconds
        });
    </script>
</body>
</html>
